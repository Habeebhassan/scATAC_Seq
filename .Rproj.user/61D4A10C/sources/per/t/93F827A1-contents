# 1. Load the ArchR library
library(ArchR)

addArchRGenome("hg38")

addArchRThreads(threads = 6)

inputFiles <- list.files(
  path = "/workspace/dataset",
  pattern = "fragments\\.tsv\\.gz_fragments\\.tsv\\.gz$", 
  full.names = TRUE
)

ArrowFiles <- createArrowFiles(
  inputFiles = inputFiles,
  sampleNames = gsub("_fragments.tsv.gz_fragments.tsv.gz", "", basename(inputFiles)),
  minTSS = 4,   
  minFrags = 500, 
  addTileMat = TRUE, 
  addGeneScoreMat = TRUE 
)

# 1.3 Add Doublet Scores to the Arrow Files
ArrowFiles <- addDoubletScores(
  input = ArrowFiles,
  k = 10
)

# 1. Manually recreate the ArrowFiles character vector by listing the generated .arrow files
# The files are now in the default 'ArrowFiles' directory.
ArrowFiles <- list.files(
  path = "ArrowFiles", # Default directory name
  pattern = ".arrow$", 
  full.names = TRUE
)

# 1.4 Create the ArchR Project object
# Use unlist to convert the list structure back to a character vector

proj <- ArchRProject(
  ArrowFiles = ArrowFiles,
  outputDirectory = "scATAC_Project",
  copyArrows = TRUE
)

# 2. Filter doublets from the project
# This removes cells marked as doublets by the previous step
proj <- filterDoublets(proj)

# 3. Inspect the Cell Metadata (Answers for Task 1.4)

# How many cells are included in your project? (The answer after filtering)
n_cells <- nrow(proj)
print(paste0("Total cells in project after initial filtering and doublet removal: ", n_cells))

# What is the median TSS value and the median number of fragments?
median_tss <- median(proj$TSS, na.rm = TRUE)
median_frags <- median(proj$nFrags, na.rm = TRUE)
print(paste0("Median TSS Enrichment Score: ", median_tss))
print(paste0("Median Number of Fragments: ", median_frags))

# What is the dimension of the tile set your dataset?
# This is stored in the ArchR metadata. The dimension is (number of cells) x (number of genomic tiles)
tile_matrix_dims <- dim(getMatrix(proj, matrixName = "TileMatrix"))
print(paste0("Dimension of the Tile Matrix (Cells x Tiles): ", tile_matrix_dims[1], " x ", tile_matrix_dims[2]))

# Summary of doublet removal
df <- getCellColData(proj)
cells_removed_count <- sum(df$Doublet)
cells_retained_count <- sum(!df$Doublet)
doublet_rate <- cells_removed_count / (cells_removed_count + cells_retained_count)

print(paste0("Total cells removed as doublets: ", cells_removed_count))
print(paste0("Calculated doublet rate: ", round(doublet_rate * 100, 2), "%"))

# Report the calculated doublet rate and the number of cells removed.
